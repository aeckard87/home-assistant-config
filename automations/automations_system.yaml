#######################################################################################################################
## System - Hassio Startup
#######################################################################################################################
  - id: system_hassio_startup
    alias: "[System] Hassio Startup"
    description: "Reset log level to set value after startup is complete."
    initial_state: 'on'

    trigger:
      # run when home assistant started
      - platform: homeassistant
        event: start

    action:
      # wait for delayed automations to turn on
      - wait_template: "{{ is_state('group.delayed_automations', 'on') }}"
        timeout: '00:05:00'
        continue_on_timeout: true

      # additional delay to allow all startup automations to completely finish
      - delay: '00:02:00'

      # set log level to value set in front end
      # set to info in config so we always log startup
      - service: logger.set_default_level
        data_template:
          level: "{{ states('input_select.log_level') }}"

      - service: system_log.write
        data_template:
          message: "**** DEFAULT LOG LEVEL HAS BEEN SET TO : {{ states('input_select.log_level') }} *****"
          level: warning

#######################################################################################################################
## Purge Motion Capture Folder
#######################################################################################################################
  - id: system_purge_capture_folder
    alias: "[System] Purge Capture Folder"
    description: "Purge alarm image capture folder."
    initial_state: 'on'

    trigger:
      # run every day at 2:00am
      - platform: time
        at: '02:00:00'

    condition:
      - condition: and
        conditions:
          # only run if system automation is enabled
          - condition: state
            entity_id: input_boolean.system_automation
            state: 'on'

          # only run if manual mode is off
          - condition: state
            entity_id: input_boolean.manual_mode
            state: 'off'

          # only run on the first of every month or when folder size is > 100 MB
          - condition: template
            value_template: "{{ now().day == 1 or states('sensor.capture') | int > 100 }}"

    action:
      # run folder purge shell command
      - service: shell_command.haclean_capture

#######################################################################################################################
## Purge TTS Folder
#######################################################################################################################
  - id: system_purge_tts_folder
    alias: "[System] Purge TTS Folder"
    description: "Purge TTS cache folder."
    initial_state: 'on'

    trigger:
      # run every day at 2:05am
      # stagger from sensor.capture so they both don't fire at same time
      - platform: time
        at: '02:05:00'

    condition:
      - condition: and
        conditions:
          # only run if system automation is enabled
          - condition: state
            entity_id: input_boolean.system_automation
            state: 'on'

          # only run if manual mode is off
          - condition: state
            entity_id: input_boolean.manual_mode
            state: 'off'

          # only run on the first of every month or when folder size is > 100 MB
          - condition: template
            value_template: "{{ now().day == 1 or states('sensor.tts') | int > 100 }}"

    action:
      # run folder purge shell command
      - service: shell_command.haclean_tts

#######################################################################################################################
## Log Level Selection
#######################################################################################################################
  - id: system_log_level_changed
    alias: "[System] Log Level Changed"
    description: "Change system log level to set value."
    initial_state: 'on'

    trigger:
      - platform: state
        entity_id: input_select.log_level

    action:
      - service: logger.set_default_level
        data_template:
          level: "{{ trigger.to_state.state }}"

      - service: system_log.write
        data_template:
          message: "**** DEFAULT LOG LEVEL SET TO : {{ trigger.to_state.state }} *****"
          level: warning

#######################################################################################################################
## Weekly Server Reboot #DISABLED
#######################################################################################################################
  - id: system_hassio_server_reboot
    alias: "[System] Hassio Server Reboot"
    description: "Reboot Hassio server once per week."
    initial_state: 'off'

    trigger:
      - platform: time
        at: '05:00:00'

    condition:
      - condition: and
        conditions:
          # only run if system automation is enabled
          - condition: state
            entity_id: input_boolean.system_automation
            state: 'on'

          # only run if manual mode is off
          - condition: state
            entity_id: input_boolean.manual_mode
            state: 'off'

          - condition: time
            weekday:
              - sun

    action:
      - service: hassio.host_reboot

#######################################################################################################################
## Hassio Update Notification
#######################################################################################################################
  - id: system_hassio_update_notification
    alias: "[System] Hassio Update Notification"
    description: "Reboot Hassio server once per week."
    initial_state: 'on'

    trigger:
      # run when updater sensor has turned on
      - platform: state
        entity_id: binary_sensor.updater
        from: 'off'
        to: 'on'

    action:
      # create persistent notification
      - service: persistent_notification.create
        data_template:
          notification_id: 'hassio_update'
          message: "Home Assistant version {{ state_attr('binary_sensor.updater', 'newest_version') }} is available."
          title: "Hassio Update Available"

#######################################################################################################################
## ZWave Network Alert
#######################################################################################################################
  - id: system_zwave_network_alert
    alias: "[System] ZWave Network Alert"
    description: "Send notification when zwave alert turns on."
    initial_state: 'on'

    trigger:
      # run when zwave_status is off
      - platform: state
        entity_id: binary_sensor.zwave_status
        to: 'off'
        for:
          minutes: 5

    condition:
      - condition: and
        conditions:
          # only run if system automation is enabled
          - condition: state
            entity_id: input_boolean.system_automation
            state: 'on'

          # only run if silent mode is off
          - condition: state
            entity_id: input_boolean.silent_mode
            state: 'off'

    action:
      # create persistent notification
      - service: persistent_notification.create
        data_template:
          title: &zwave_title "ZWave Status"
          message: &zwave_message "Z-Wave network alert!.\n{{ now().strftime('%H:%M  %Y-%m-%d') }}"
          notification_id: 'zwave_alert'

      # send push notification
      - service_template: "{% if is_state('binary_sensor.notify_jason_laptop','on' ) %} notify.jason {% else %} notify.jason_away {% endif %}"
        data_template:
          title: *zwave_title
          message: *zwave_message
          data:
            actions:
              - action: 'pause_zwave_alert'
                title: "Pause Alerts"
                icon: !secret PAUSE_BUTTON
            tag: 'zwave_alert'
            timestamp: "{{ as_timestamp(now()) }}"
            renotify: true
            ttl: 43200 # 12h
            priority: normal
            requireInteraction: false
            silent: true
            url: '/lovelace/system'
            icon: !secret ZWAVE_ICON
            image: !secret ZWAVE_IMAGE
            badge: !secret ZWAVE_BADGE

#######################################################################################################################
## System - Close Zwave Status Alert Notifications
#######################################################################################################################
  - id: system_close_zwave_status_alert_notifications
    alias: "[System] Close Zwave Status Alert Notifications"
    description: "Dismiss notifications on all devices when closed on one."
    initial_state: 'on'

    trigger:
      # run when the zwave_status turns on
      - platform: state
        entity_id: binary_sensor.zwave_status
        to: 'on'
        for:
          minutes: 1

      # run when notification closed
      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: 'zwave_alert'

      # run when notification clicked
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          tag: 'zwave_alert'

      # run when persistent notification state changes #BUGFIX - can't check state from:
      - platform: event
        event_type: state_changed
        event_data:
          entity_id: persistent_notification.zwave_alert

    condition:
      - condition: or
        conditions:
          # can run if zwave_status has turned off
          - condition: state
            entity_id: binary_sensor.zwave_status
            state: 'off'

          # can run if the push event tag is zwave_alert
          # required due to perisitent notification condition #BUGFIX
          - condition: template
            value_template: "{{ trigger.event.data['tag'] == 'zwave_alert' }}"

          # can run if the persistent notification state is unknown (was closed) #BUGFIX
          # state will by 'notifying' when persistent notification is created
          - condition: template
            value_template: "{{ states('persistent_notification.zwave_alert') == 'unknown' }}"

    action:
     # turn off automation to avoid recursive calls
      - service: automation.turn_off
        entity_id: automation.system_close_zwave_status_alert_notifications

      # dismiss persistent notification
      - service: persistent_notification.dismiss
        data:
          notification_id: 'zwave_alert'

      # dismiss push notifications for all devices
      # - service: notify.html5_dismiss
      #   data:
      #     data:
      #       tag: 'zwave_alert'

      # turn automation back on
      - service: automation.turn_on
        entity_id: automation.system_close_zwave_status_alert_notifications

#######################################################################################################################
## Action - Pause ZWave Status Alerts
#######################################################################################################################
  - id: system_pause_zwave_status_alerts
    alias: "[System] Pause ZWave Status Alerts"
    description: "Dismiss notifications and temporarily turn off alert automation."
    initial_state: 'on'

    trigger:
      # run when notification button clicked
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: 'pause_zwave_alert'

    action:
      # turn off automation to avoid recursive calls
      - service: automation.turn_off
        entity_id: automation.system_close_zwave_status_alert_notifications

      # dismiss persistent notification
      - service: persistent_notification.dismiss
        data:
          notification_id: 'zwave_alert'

      # dismiss push notifications for all devices
      # - service: notify.html5_dismiss
      #   data:
      #     data:
      #       tag: 'zwave_alert'

      # turn automation back on
      - service: automation.turn_on
        entity_id: automation.system_close_zwave_status_alert_notifications

      # turn off alert automation
      - service: automation.turn_off
        entity_id: automation.system_zwave_network_alert

      # wait for timeout or automation to be turned back on
      - wait_template: "{{ is_state('automation.system_zwave_network_alert', 'on') }}"
        timeout: '04:00:00' # mute alert for 4 hours
        continue_on_timeout: true

      # turn alert automation back on
      - service: automation.turn_on
        entity_id: automation.system_zwave_network_alert

#######################################################################################################################
## High Processor Use Alert
#######################################################################################################################
  - id: system_high_processor_use_alert
    alias: "[System] High Processor Use Alert"
    description: "Send notification when processor use alert turns on."
    initial_state: 'on'

    trigger:
      # run when the processor_use_alert is active
      - platform: state
        entity_id: binary_sensor.processor_use_alert
        to: 'on'
        for:
          minutes: 5

    condition:
      - condition: and
        conditions:
          # only run if system automation is enabled
          - condition: state
            entity_id: input_boolean.system_automation
            state: 'on'

          # only run if silent mode is off
          - condition: state
            entity_id: input_boolean.silent_mode
            state: 'off'

    action:
      # create persistent notification
      - service: persistent_notification.create
        data_template:
          title: &processor_title "High Processor Use"
          message: &processor_message "Processor: {{ states('sensor.processor_use') }}%\n{{ now().strftime('%H:%M  %Y-%m-%d') }}"
          notification_id: 'processor_alert'

      # send push notification
      - service_template: "{% if is_state('binary_sensor.notify_jason_laptop','on' ) %} notify.jason {% else %} notify.jason_away {% endif %}"
        data_template:
          title: *processor_title
          message: *processor_message
          data:
            actions:
              - action: 'pause_processor_alert'
                title: "Pause Alerts"
                icon: !secret PAUSE_BUTTON
            tag: 'processor_alert'
            timestamp: "{{ as_timestamp(now()) }}"
            renotify: true
            ttl: 43200 # 12h
            priority: normal
            requireInteraction: false
            silent: true
            url: '/lovelace/system'
            icon: !secret PROCESSOR_ICON
            image: !secret PROCESSOR_IMAGE
            badge: !secret PROCESSOR_BADGE

#######################################################################################################################
## System - Close Processor Use Alert Notifications
#######################################################################################################################
  - id: system_close_processor_use_alert_notifications
    alias: "[System] Close Processor Use Alert Notifications"
    description: "Dismiss notifications on all devices when closed on one."
    initial_state: 'on'

    trigger:
      # run when the processor_use_alert turns off
      - platform: state
        entity_id: binary_sensor.processor_use_alert
        to: 'off'
        for:
          minutes: 1

      # run when notification closed
      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: 'processor_alert'

      # run when notification clicked
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          tag: 'processor_alert'

      # run when persistent notification state changes #BUGFIX - can't check state from:
      - platform: event
        event_type: state_changed
        event_data:
          entity_id: persistent_notification.processor_alert

    condition:
      - condition: or
        conditions:
          # can run if processor_use_alert has turned off
          - condition: state
            entity_id: binary_sensor.processor_use_alert
            state: 'off'

          # can run if the push event tag is processor_alert
          # required due to perisitent notification condition #BUGFIX
          - condition: template
            value_template: "{{ trigger.event.data['tag'] == 'processor_alert' }}"

          # can run if the persistent notification state is unknown (was closed) #BUGFIX
          # state will by 'notifying' when persistent notification is created
          - condition: template
            value_template: "{{ states('persistent_notification.processor_alert') == 'unknown' }}"

    action:
     # turn off automation to avoid recursive calls
      - service: automation.turn_off
        entity_id: automation.system_close_processor_use_alert_notifications

      # dismiss persistent notification
      - service: persistent_notification.dismiss
        data:
          notification_id: 'processor_alert'

      # dismiss push notifications for all devices
      # - service: notify.html5_dismiss
      #   data:
      #     data:
      #       tag: 'processor_alert'

      # turn automation back on
      - service: automation.turn_on
        entity_id: automation.system_close_processor_use_alert_notifications

#######################################################################################################################
## System - Pause Processor Use Alerts
#######################################################################################################################
  - id: system_pause_processor_use_alerts
    alias: "[System] Pause Processor Use Alerts"
    description: "Dismiss notifications and temporarily turn off alert automation."
    initial_state: 'on'

    trigger:
      # run when notification button clicked
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: 'pause_processor_alert'

    action:
      # turn off automation to avoid recursive calls
      - service: automation.turn_off
        entity_id: automation.system_close_processor_use_alert_notifications

      # dismiss persistent notification
      - service: persistent_notification.dismiss
        data:
          notification_id: 'processor_alert'

      # dismiss push notifications for all devices
      # - service: notify.html5_dismiss
      #   data:
      #     data:
      #       tag: 'processor_alert'

      # turn automation back on
      - service: automation.turn_on
        entity_id: automation.system_close_processor_use_alert_notifications

      # turn off alert automation
      - service: automation.turn_off
        entity_id: automation.system_high_processor_use_alert

      # wait for timeout or automation to be turned back on
      - wait_template: "{{ is_state('automation.system_high_processor_use_alert', 'on') }}"
        timeout: '04:00:00' # mute alert for 4 hours
        continue_on_timeout: true

      # turn alert automation back on
      - service: automation.turn_on
        entity_id: automation.system_high_processor_use_alert

#######################################################################################################################
## High Memory Use Alert
#######################################################################################################################
  - id: system_high_memory_use_alert
    alias: "[System] High Memory Use Alert"
    description: "Send notification when memory use alert turns on."
    initial_state: 'on'

    trigger:
      # run when the memory use alert is active
      - platform: state
        entity_id: binary_sensor.memory_use_alert
        to: 'on'
        for:
          minutes: 5

    condition:
      - condition: and
        conditions:
          # only run if system automation is enabled
          - condition: state
            entity_id: input_boolean.system_automation
            state: 'on'

          # only run if silent mode is off
          - condition: state
            entity_id: input_boolean.silent_mode
            state: 'off'

    action:
      # create persistent notification
      - service: persistent_notification.create
        data_template:
          title: &memory_title "High Memory Use"
          message: &memory_message "Memory Use - {{ states('sensor.memory_use_percent') }}%\n{{ now().strftime('%H:%M  %Y-%m-%d') }}"
          notification_id: 'memory_alert'

      # send push notification
      - service_template: "{% if is_state('binary_sensor.notify_jason_laptop','on' ) %} notify.jason {% else %} notify.jason_away {% endif %}"
        data_template:
          title: *memory_title
          message: *memory_message
          data:
            actions:
              - action: 'pause_memory_alert'
                title: "Pause Alerts"
                icon: !secret PAUSE_BUTTON
            tag: 'memory_alert'
            timestamp: "{{ as_timestamp(now()) }}"
            renotify: true
            ttl: 43200 # 12h
            priority: normal
            requireInteraction: false
            silent: true
            url: '/lovelace/system'
            icon: !secret MEMORY_ICON
            image: !secret MEMORY_IMAGE
            badge: !secret MEMORY_BADGE

#######################################################################################################################
## System - Close Memory Alert Notifications
#######################################################################################################################
  - id: system_close_memory_alert_notifications
    alias: "[System] Close Memory Alert Notifications"
    description: "Dismiss notifications on all devices when closed on one."
    initial_state: 'on'

    trigger:
      # run when the memory_use_alert turns off
      - platform: state
        entity_id: binary_sensor.memory_use_alert
        to: 'off'
        for:
          minutes: 1

      # run when notification closed
      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: 'memory_alert'

      # run when notification clicked
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          tag: 'memory_alert'

      # run when persistent notification state changes #BUGFIX - can't check state from:
      - platform: event
        event_type: state_changed
        event_data:
          entity_id: persistent_notification.memory_alert

    condition:
      - condition: or
        conditions:
          # can run if memory_use_alert has turned off
          - condition: state
            entity_id: binary_sensor.memory_use_alert
            state: 'off'

          # can run if the push event tag is memory_alert
          # required due to perisitent notification condition #BUGFIX
          - condition: template
            value_template: "{{ trigger.event.data['tag'] == 'memory_alert' }}"

          # can run if the persistent notification state is unknown (was closed) #BUGFIX
          # state will by 'notifying' when persistent notification is created
          - condition: template
            value_template: "{{ states('persistent_notification.memory_alert') == 'unknown' }}"

    action:
     # turn off automation to avoid recursive calls
      - service: automation.turn_off
        entity_id: automation.system_close_memory_alert_notifications

      # dismiss persistent notification
      - service: persistent_notification.dismiss
        data:
          notification_id: 'memory_alert'

      # dismiss push notifications for all devices
      # - service: notify.html5_dismiss
      #   data:
      #     data:
      #       tag: 'memory_alert'

      # turn automation back on
      - service: automation.turn_on
        entity_id: automation.system_close_memory_alert_notifications

#######################################################################################################################
## System - Pause Memory Alerts
#######################################################################################################################
  - id: system_pause_memory_alerts
    alias: "[System] Pause Memory Alerts"
    description: "Dismiss notifications and temporarily turn off alert automation."
    initial_state: 'on'

    trigger:
      # run when notification button clicked
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: 'pause_memory_alert'

    action:
      # turn off automation to avoid recursive calls
      - service: automation.turn_off
        entity_id: automation.system_close_memory_alert_notifications

      # dismiss persistent notification
      - service: persistent_notification.dismiss
        data:
          notification_id: 'memory_alert'

      # dismiss push notifications for all devices
      # - service: notify.html5_dismiss
      #   data:
      #     data:
      #       tag: 'memory_alert'

      # turn automation back on
      - service: automation.turn_on
        entity_id: automation.system_close_memory_alert_notifications

      # turn off alert automation
      - service: automation.turn_off
        entity_id: automation.system_high_memory_use_alert

      # wait for timeout or automation to be turned back on
      - wait_template: "{{ is_state('automation.system_high_memory_use_alert', 'on') }}"
        timeout: '04:00:00' # mute alert for 4 hours
        continue_on_timeout: true

      # turn alert automation back on
      - service: automation.turn_on
        entity_id: automation.system_high_memory_use_alert

#######################################################################################################################
## System - RPI Power Alert
#######################################################################################################################
  - id: system_rpi_power_alert
    alias: "[System] RPi Power Alert"
    description: "Send notification when RPi power alert turns on."
    initial_state: 'on'

    trigger:
      # run when the rpi_power_alert is active
      - platform: state
        entity_id: binary_sensor.rpi_power_alert
        to: 'on'
        for:
          seconds: 5 # only 5 sec false triggers delay

    condition:
      - condition: and
        conditions:
          # only run if system automation is enabled
          - condition: state
            entity_id: input_boolean.system_automation
            state: 'on'

          # only run if silent mode is off
          - condition: state
            entity_id: input_boolean.silent_mode
            state: 'off'

    action:
      # create persistent notification
      - service: persistent_notification.create
        data_template:
          title: &power_title "RPi Power Problem"
          message: &power_message "{{ states('sensor.rpi_power_status') }}\n{{now().strftime('%H:%M  %Y-%m-%d') }}"
          notification_id: 'power_alert'

      # send push notification
      - service_template: "{% if is_state('binary_sensor.notify_jason_laptop','on' ) %} notify.jason {% else %} notify.jason_away {% endif %}"
        data_template:
          title: *power_title
          message: *power_message
          data:
            actions:
              - action: 'pause_power_alert'
                title: "Pause Alerts"
                icon: !secret PAUSE_BUTTON
            tag: 'power_alert'
            timestamp: "{{ as_timestamp(now()) }}"
            renotify: true
            ttl: 43200 # 12h
            priority: normal
            requireInteraction: false
            silent: true
            url: '/lovelace/system'
            icon: !secret PROCESSOR_ICON
            image: !secret PROCESSOR_IMAGE
            badge: !secret PROCESSOR_BADGE

#######################################################################################################################
## System - Close RPI Power Alert Notifications
#######################################################################################################################
  - id: system_close_rpi_power_alert_notifications
    alias: "[System] Close RPI Power Alert Notifications"
    description: "Dismiss notifications on all devices when closed on one."
    initial_state: 'on'

    trigger:
      # run when the rpi_power_alert turns off
      - platform: state
        entity_id: binary_sensor.rpi_power_alert
        to: 'off'
        for:
          minutes: 1

      # run when notification closed
      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: 'power_alert'

      # run when notification clicked
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          tag: 'power_alert'

      # run when persistent notification state changes #BUGFIX - can't check state from:
      - platform: event
        event_type: state_changed
        event_data:
          entity_id: persistent_notification.power_alert

    condition:
      - condition: or
        conditions:
          # can run if rpi_power_alert has turned off
          - condition: state
            entity_id: binary_sensor.rpi_power_alert
            state: 'off'

          # can run if the push event tag is power_alert
          # required due to perisitent notification condition #BUGFIX
          - condition: template
            value_template: "{{ trigger.event.data['tag'] == 'power_alert' }}"

          # can run if the persistent notification state is unknown (was closed) #BUGFIX
          # state will by 'notifying' when persistent notification is created
          - condition: template
            value_template: "{{ states('persistent_notification.power_alert') == 'unknown' }}"

    action:
     # turn off automation to avoid recursive calls
      - service: automation.turn_off
        entity_id: automation.system_close_rpi_power_alert_notifications

      # dismiss persistent notification
      - service: persistent_notification.dismiss
        data:
          notification_id: 'power_alert'

      # dismiss push notifications for all devices
      # - service: notify.html5_dismiss
      #   data:
      #     data:
      #       tag: 'power_alert'

      # turn automation back on
      - service: automation.turn_on
        entity_id: automation.system_close_rpi_power_alert_notifications

#######################################################################################################################
## System - Pause RPi Power Alerts
#######################################################################################################################
  - id: system_pause_rpi_power_alerts
    alias: "[System] ause RPi Power Alerts"
    description: "Dismiss notifications and temporarily turn off alert automation."
    initial_state: 'on'

    trigger:
      # run when notification button clicked
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: 'pause_power_alert'

    action:
      # turn off automation to avoid recursive calls
      - service: automation.turn_off
        entity_id: automation.system_close_rpi_power_alert_notifications

      # dismiss persistent notification
      - service: persistent_notification.dismiss
        data:
          notification_id: 'power_alert'

      # dismiss push notifications for all devices
      # - service: notify.html5_dismiss
      #   data:
      #     data:
      #       tag: 'power_alert'

      # turn automation back on
      - service: automation.turn_on
        entity_id: automation.system_close_rpi_power_alert_notifications

      # turn off alert automation
      - service: automation.turn_off
        entity_id: automation.system_rpi_power_alert

      # wait for timeout or automation to be turned back on
      - wait_template: "{{ is_state('automation.system_rpi_power_problem_alert', 'on') }}"
        timeout: '04:00:00' # mute alert for 4 hours
        continue_on_timeout: true

      # turn alert automation back on
      - service: automation.turn_on
        entity_id: automation.system_rpi_power_alert

#######################################################################################################################
## System - Disk Usage Alert
#######################################################################################################################
  - id: system_disk_usage_alert
    alias: "[System] Disk Usage Alert"
    description: "Send notification when disk usage alert turns on."
    initial_state: 'on'

    trigger:
      # run when the disk_usage_alert is active
      - platform: state
        entity_id: binary_sensor.disk_usage_alert
        to: 'on'
        for:
          minutes: 5

    condition:
      - condition: and
        conditions:
          # only run if system automation is enabled
          - condition: state
            entity_id: input_boolean.system_automation
            state: 'on'

          # only run if silent mode is off
          - condition: state
            entity_id: input_boolean.silent_mode
            state: 'off'

    action:
      # create persistent notification
      - service: persistent_notification.create
        data_template:
          title: &disk_title "Disk Usage Warning"
          message: &disk_message "Disk Usage - {{ states.sensor.disk_use_percent_home.state }}%\n{{ now().strftime('%H:%M  %Y-%m-%d') }}"
          notification_id: 'disk_alert'

      # send push notification
      - service_template: "{% if is_state('binary_sensor.notify_jason_laptop','on' ) %} notify.jason {% else %} notify.jason_away {% endif %}"
        data_template:
          title: *disk_title
          message: *disk_message
          data:
            actions:
              - action: 'pause_disk_alert'
                title: "Pause Alerts"
                icon: !secret PAUSE_BUTTON
            tag: 'disk_alert'
            timestamp: "{{ as_timestamp(now()) }}"
            renotify: true
            ttl: 43200 # 12h
            priority: normal
            requireInteraction: false
            silent: true
            url: '/lovelace/system'
            icon: !secret DISK_ICON
            image: !secret DISK_IMAGE
            badge: !secret DISK_BADGE

#######################################################################################################################
## System - Close Disk Alert Notifications
#######################################################################################################################
  - id: system_close_disk_alert_notifications
    alias: "[System] Close Disk Alert Notifications"
    description: "Dismiss notifications on all devices when closed on one."
    initial_state: 'on'

    trigger:
      # run when the disk_usage_alert turns off
      - platform: state
        entity_id: binary_sensor.disk_usage_alert
        to: 'off'
        for:
          minutes: 1

      # run when notification closed
      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: 'disk_alert'

      # run when notification clicked
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          tag: 'disk_alert'

      # run when persistent notification state changes #BUGFIX - can't check state from:
      - platform: event
        event_type: state_changed
        event_data:
          entity_id: persistent_notification.disk_alert

    condition:
      - condition: or
        conditions:
          # can run if disk_usage_alert has turned off
          - condition: state
            entity_id: binary_sensor.disk_usage_alert
            state: 'off'

          # can run if the push event tag is disk_alert
          # required due to perisitent notification condition #BUGFIX
          - condition: template
            value_template: "{{ trigger.event.data['tag'] == 'disk_alert' }}"

          # can run if the persistent notification state is unknown (was closed) #BUGFIX
          # state will by 'notifying' when persistent notification is created
          - condition: template
            value_template: "{{ states('persistent_notification.disk_alert') == 'unknown' }}"

    action:
     # turn off automation to avoid recursive calls
      - service: automation.turn_off
        entity_id: automation.system_close_disk_alert_notifications

      # dismiss persistent notification
      - service: persistent_notification.dismiss
        data:
          notification_id: 'disk_alert'

      # dismiss push notifications for all devices
      # - service: notify.html5_dismiss
      #   data:
      #     data:
      #       tag: 'disk_alert'

      # turn automation back on
      - service: automation.turn_on
        entity_id: automation.system_close_disk_alert_notifications

#######################################################################################################################
## System - Pause Disk Alerts
#######################################################################################################################
  - id: system_pause_disk_alerts
    alias: "[System] Pause Disk Alerts"
    description: "Dismiss notifications and temporarily turn off alert automation."
    initial_state: 'on'

    trigger:
      # run when notification button clicked
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: 'pause_disk_alert'

    action:
      # turn off automation to avoid recursive calls
      - service: automation.turn_off
        entity_id: automation.system_close_disk_alert_notifications

      # dismiss persistent notification
      - service: persistent_notification.dismiss
        data:
          notification_id: 'disk_alert'

      # dismiss push notifications for all devices
      # - service: notify.html5_dismiss
      #   data:
      #     data:
      #       tag: 'disk_alert'

      # turn automation back on
      - service: automation.turn_on
        entity_id: automation.system_close_disk_alert_notifications

      # turn off alert automation
      - service: automation.turn_off
        entity_id: automation.system_disk_usage_alert

      # wait for timeout or automation to be turned back on
      - wait_template: "{{ is_state('automation.system_disk_usage_alert', 'on') }}"
        timeout: '04:00:00' # mute alert for 4 hours
        continue_on_timeout: true

      # turn alert automation back on
      - service: automation.turn_on
        entity_id: automation.system_disk_usage_alert

#######################################################################################################################
## System - Battery Status Alert
#######################################################################################################################
  - id: system_battery_status_alert
    alias: "[System] Battery Status Alert"
    description: "Send notification when battery level alert turns on."
    initial_state: 'on'

    trigger:
      # run when the battery_status_alert is active
      - platform: state
        entity_id: binary_sensor.battery_status_alert
        to: 'on'
        for:
          minutes: 5

      # run whenever the battery alert threshold is changed
      - platform: state
        entity_id: input_number.battery_alert_threshold

    condition:
      - condition: and
        conditions:
          # only run if system automation is enabled
          - condition: state
            entity_id: input_boolean.system_automation
            state: 'on'

          # only run if silent mode is off
          - condition: state
            entity_id: input_boolean.silent_mode
            state: 'off'

          # test for alert sensor so doesn't run when input_number is adjusted unless alert on
          - condition: state
            entity_id: binary_sensor.battery_status_alert
            state: 'on'

    action:
      # create persistent notification
      - service: persistent_notification.create
        data_template:
          notification_id: 'battery_alert'
          title: &battery_title "Low Battery Level"
          message: &battery_message >-
            {%- set battery_alert_threshold = states('input_number.battery_alert_threshold') | int -%}
            {%- set zwave_batteries = states.zwave  | selectattr('attributes.battery_level', 'defined')
                                                  | selectattr('attributes.battery_level','<', battery_alert_threshold )
                                                  | map(attribute='name') | list | join('\n ') -%}
            {%- set nest_batteries = states.sensor  | selectattr('name', 'in', 'nest_protect_battery_health')
                                                    | select('state','eq', 'replace' )
                                                    | map(attribute='name') | list | join('\n ') -%}

            {%- set low_batteries = zwave_batteries + '\n' + nest_batteries -%}
            Low batteries in the following devices: {{ '\n' + low_batteries | title }}

      # send push notification
      - service_template: "{% if is_state('binary_sensor.notify_jason_laptop','on' ) %} notify.jason {% else %} notify.jason_away {% endif %}"
        data_template:
          title: *battery_title
          message: *battery_message
          data:
            actions:
              - action: 'pause_battery_alert'
                title: "Pause Alert"
                icon: !secret PAUSE_BUTTON
            tag: 'battery_alert'
            timestamp: "{{ as_timestamp(now()) }}"
            renotify: true
            ttl: 43200 # 12h
            priority: normal
            requireInteraction: false
            silent: true
            url: '/lovelace/system'
            icon: !secret BATTERY_ICON
            badge: !secret BATTERY_BADGE

#######################################################################################################################
## System - Close Battery Alert Notifications
#######################################################################################################################
  - id: system_close_battery_alert_notifications
    alias: "[System] Close Battery Alert Notifications"
    description: "Dismiss notifications on all devices when closed on one."
    initial_state: 'on'

    trigger:
      # run when the battery_status_alert turns off
      - platform: state
        entity_id: binary_sensor.battery_status_alert
        to: 'off'
        for:
          minutes: 1

      # run when notification closed
      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: 'battery_alert'

      # run when notification clicked
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          tag: 'battery_alert'

      # run when persistent notification state changes #BUGFIX - can't check state from:
      - platform: event
        event_type: state_changed
        event_data:
          entity_id: persistent_notification.battery_alert

    condition:
      - condition: or
        conditions:
          # can run if battery_status_alert has turned off
          - condition: state
            entity_id: binary_sensor.battery_status_alert
            state: 'off'

          # can run if the push event tag is battery_alert
          # required due to perisitent notification condition #BUGFIX
          - condition: template
            value_template: "{{ trigger.event.data['tag'] == 'battery_alert' }}"

          # can run if the persistent notification state is unknown (was closed) #BUGFIX
          # state will by 'notifying' when persistent notification is created
          - condition: template
            value_template: "{{ states('persistent_notification.battery_alert') == 'unknown' }}"

    action:
     # turn off automation to avoid recursive calls
      - service: automation.turn_off
        entity_id: automation.system_close_battery_alert_notifications

      # dismiss persistent notification
      - service: persistent_notification.dismiss
        data:
          notification_id: 'battery_alert'

      # dismiss push notifications for all devices
      # - service: notify.html5_dismiss
      #   data:
      #     data:
      #       tag: 'battery_alert'

      # turn automation back on
      - service: automation.turn_on
        entity_id: automation.system_close_battery_alert_notifications

#######################################################################################################################
## System - Pause Battery Alerts
#######################################################################################################################
  - id: system_pause_battery_alerts
    alias: "[System] Pause Battery Alerts"
    description: "Dismiss notifications and temporarily turn off alert automation."
    initial_state: 'on'

    trigger:
      # run when notification button clicked
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: 'pause_battery_alert'

    action:
      # turn off automation to avoid recursive calls
      - service: automation.turn_off
        entity_id: automation.system_close_battery_alert_notifications

      # dismiss persistent notification
      - service: persistent_notification.dismiss
        data:
          notification_id: 'battery_alert'

      # dismiss push notifications for all devices
      # - service: notify.html5_dismiss
      #   data:
      #     data:
      #       tag: 'battery_alert'

      # turn automation back on
      - service: automation.turn_on
        entity_id: automation.system_close_battery_alert_notifications

      # turn off alert automation
      - service: automation.turn_off
        entity_id: automation.system_battery_status_alert

      # wait for timeout or automation to be turned back on
      - wait_template: "{{ is_state('automation.system_battery_status_alert', 'on') }}"
        timeout: '04:00:00' # mute alert for 4 hours
        continue_on_timeout: true

      # turn alert automation back on
      - service: automation.turn_on
        entity_id: automation.system_battery_status_alert

#######################################################################################################################
## System - CPU Temperature Alert
#######################################################################################################################
  - id: system_cpu_temperature_alert
    alias: "[System] CPU Temperature Alert"
    description: "Send notification when CPU temperature alert turns on."
    initial_state: 'on'

    trigger:
      # run when the cpu_temperature_alert is active
      - platform: state
        entity_id: binary_sensor.cpu_temperature_alert
        to: 'on'
        for:
          minutes: 5

    condition:
      - condition: and
        conditions:
          # only run if system automation is enabled
          - condition: state
            entity_id: input_boolean.system_automation
            state: 'on'

          # only run if silent mode is off
          - condition: state
            entity_id: input_boolean.silent_mode
            state: 'off'

    action:
      # create persistent notification
      - service: persistent_notification.create
        data_template:
          title: &cputemp_title "High CPU Temp"
          message: &cputemp_message "CPU Temp - {{ states.sensor.rpi_cpu_temperature.state }}°C\n{{ now().strftime('%H:%M  %Y-%m-%d') }}"
          notification_id: 'cpu_temp_alert'

      # send push notification
      - service_template: "{% if is_state('binary_sensor.notify_jason_laptop','on' ) %} notify.jason {% else %} notify.jason_away {% endif %}"
        data_template:
          title: *cputemp_title
          message: *cputemp_message
          data:
            actions:
              - action: 'pause_cpu_temp_alert'
                title: "Pause Alert"
                icon: !secret PAUSE_BUTTON
            tag: 'cpu_temp_alert'
            timestamp: "{{ as_timestamp(now()) }}"
            renotify: true
            ttl: 43200 # 12h
            priority: normal
            requireInteraction: false
            silent: true
            url: '/lovelace/system'
            icon: !secret PROCESSOR_ICON
            image: !secret PROCESSOR_IMAGE
            badge: !secret PROCESSOR_BADGE

#######################################################################################################################
## System - Close CPU Temperature Alert Notifications
#######################################################################################################################
  - id: system_close_cpu_temperature_alert_notifications
    alias: "[System] Close CPU Temperature Alert Notifications"
    description: "Dismiss notifications on all devices when closed on one."
    initial_state: 'on'

    trigger:
      # run when the cpu_temperature_alert turns off
      - platform: state
        entity_id: binary_sensor.cpu_temperature_alert
        to: 'off'
        for:
          minutes: 1

      # run when notification closed
      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: 'cpu_temp_alert'

      # run when notification clicked
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          tag: 'cpu_temp_alert'

      # run when persistent notification state changes #BUGFIX - can't check state from:
      - platform: event
        event_type: state_changed
        event_data:
          entity_id: persistent_notification.cpu_temp_alert

    condition:
      - condition: or
        conditions:
          # can run if cpu_temperature_alert has turned off
          - condition: state
            entity_id: binary_sensor.cpu_temperature_alert
            state: 'off'

          # can run if the push event tag is cpu_temp_alert
          # required due to perisitent notification condition #BUGFIX
          - condition: template
            value_template: "{{ trigger.event.data['tag'] == 'cpu_temp_alert' }}"

          # can run if the persistent notification state is unknown (was closed) #BUGFIX
          # state will by 'notifying' when persistent notification is created
          - condition: template
            value_template: "{{ states('persistent_notification.cpu_temp_alert') == 'unknown' }}"

    action:
     # turn off automation to avoid recursive calls
      - service: automation.turn_off
        entity_id: automation.system_close_cpu_temperature_alert_notifications

      # dismiss persistent notification
      - service: persistent_notification.dismiss
        data:
          notification_id: 'cpu_temp_alert'

      # dismiss push notifications for all devices
      # - service: notify.html5_dismiss
      #   data:
      #     data:
      #       tag: 'cpu_temp_alert'

      # turn automation back on
      - service: automation.turn_on
        entity_id: automation.system_close_cpu_temperature_alert_notifications

#######################################################################################################################
## System - Pause CPU Temperature Alerts
#######################################################################################################################
  - id: system_pause_cpu_temperature_alerts
    alias: "[System] Pause CPU Temperature Alerts"
    description: "Dismiss notifications and temporarily turn off alert automation."
    initial_state: 'on'

    trigger:
      # run when notification button clicked
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: 'pause_cpu_temp_alert'

    action:
      # turn off automation to avoid recursive calls
      - service: automation.turn_off
        entity_id: automation.system_close_cpu_temperature_alert_notifications

      # dismiss persistent notification
      - service: persistent_notification.dismiss
        data:
          notification_id: 'cpu_temp_alert'

      # dismiss push notifications for all devices
      # - service: notify.html5_dismiss
      #   data:
      #     data:
      #       tag: 'cpu_temp_alert'

      # turn automation back on
      - service: automation.turn_on
        entity_id: automation.system_close_cpu_temperature_alert_notifications

      # turn off alert automation
      - service: automation.turn_off
        entity_id: automation.system_cpu_temperature_alert

      # wait for timeout or automation to be turned back on
      - wait_template: "{{ is_state('automation.system_cpu_temperature_alert', 'on') }}"
        timeout: '04:00:00' # mute alert for 4 hours
        continue_on_timeout: true

      # turn alert automation back on
      - service: automation.turn_on
        entity_id: automation.system_cpu_temperature_alert

#######################################################################################################################
## System - Sensor Unavailable Alert
## - triggers every time the number of unavailable sensors goes up
## - waits 30 seconds and the rechecks before sending notification so we don't get false alerts
## - group.delayed_automations
#######################################################################################################################
  - id: system_sensor_unavailable_alert
    alias: "[System] Sensor Unavailable Alert"
    description: "Send notification when sensor goes offline."
    initial_state: 'off'

    trigger:
      # run whenever unavailable sensors sensor state changes
      - platform: state
        entity_id: sensor.unavailable_sensors

    condition:
      - condition: and
        conditions:
          # only run if system automation is enabled
          - condition: state
            entity_id: input_boolean.system_automation
            state: 'on'

          # only run if silent mode is off
          - condition: state
            entity_id: input_boolean.silent_mode
            state: 'off'

          # only run if the number of unavailable sensors had gone up
          - condition: template
            value_template: "{{ trigger.to_state.state | int > trigger.from_state.state | int }}"

    action:
      # wait 30 seconds before rechecking sensor state
      - delay:
          seconds: 30

      # make sure the sensor is updated before we check the state
      - service: homeassistant.update_entity
        entity_id: sensor.unavailable_sensors

      # only continue if current number of sensors is equal or more than the number when triggered
      - condition: template
        value_template: "{{ states('sensor.unavailable_sensors') | int >= trigger.to_state.state | int }} "

      # create a persistent notification
      - service: persistent_notification.create
        data_template:
          title: "Unavailable Sensors"
          message: "{{ state_attr('sensor.unavailable_sensors','sensor_names').split(', ') | join('\n') }}"
          notification_id: 'sensor_alert'

      # send push notification
      - service_template: "{% if is_state('binary_sensor.notify_jason_laptop','on' ) %} notify.jason {% else %} notify.jason_away {% endif %}"
        data_template:
          title: "Unavailable Sensors"
          message: "{{ state_attr('sensor.unavailable_sensors','sensor_names').split(', ') | join('\n') }}"
          data:
            actions:
              - action: 'pause_sensor_alert'
                title: "Pause Alerts"
                icon: !secret PAUSE_BUTTON
            tag: 'sensor_alert'
            timestamp: "{{ as_timestamp(now()) }}"
            renotify: true
            ttl: 43200 # 12h
            priority: normal
            requireInteraction: false
            silent: true
            url: '/lovelace/system'
            icon: !secret OFFLINE_ICON
            badge: !secret OFFLINE_BADGE

#######################################################################################################################
## System - Close Sensor Unavailable Notifications
#######################################################################################################################
  - id: system_close_sensor_unavailable_notifications
    alias: "[System] Close Sensor Unavailable Notifications"
    description: "Dismiss notifications on all devices when closed on one."
    initial_state: 'on'

    trigger:
      # run when there are no more unavailable sensors
      - platform: numeric_state
        entity_id: sensor.unavailable_sensors
        below: 1
        for:
          minutes: 1

      # run when notification closed
      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: 'sensor_alert'

      # run when notification clicked
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          tag: 'sensor_alert'

      # run when persistent notification state changes #BUGFIX - can't check state from:
      - platform: event
        event_type: state_changed
        event_data:
          entity_id: persistent_notification.sensor_alert

    condition:
      - condition: or
        conditions:
          # can run if unavailable_sensors is 0
          - condition: numeric_state
            entity_id: sensor.unavailable_sensors
            below: 1

          # can run if the push event tag is cpu_temp_alert
          # required due to perisitent notification condition #BUGFIX
          - condition: template
            value_template: "{{ trigger.event.data['tag'] == 'sensor_alert' }}"

          # can run if the persistent notification state is unknown (was closed) #BUGFIX
          # state will by 'notifying' when persistent notification is created
          - condition: template
            value_template: "{{ states('persistent_notification.sensor_alert') == 'unknown' }}"

    action:
      # turn off automation to avoid recursive calls
      - service: automation.turn_off
        entity_id: automation.system_close_sensor_unavailable_notifications

      # dismiss persistent notification
      - service: persistent_notification.dismiss
        data:
          notification_id: 'sensor_alert'

      # dismiss push notifications for all devices
      # - service: notify.html5_dismiss
      #   data:
      #     data:
      #       tag: 'sensor_alert'

      # turn automation back on
      - service: automation.turn_on
        entity_id: automation.system_close_sensor_unavailable_notifications

#######################################################################################################################
## System - Pause Sensor Unavailable Alerts
#######################################################################################################################
  - id: system_pause_sensor_unavailable_alerts
    alias: "[System] Pause Sensor Unavailable Alerts"
    description: "Dismiss notifications and temporarily turn off alert automation."
    initial_state: 'on'

    trigger:
      # run when notification button clicked
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: 'pause_sensor_alert'

    action:
     # turn off automation to avoid recursive calls
      - service: automation.turn_off
        entity_id: automation.system_close_sensor_unavailable_notifications

      # dismiss persistent notification
      - service: persistent_notification.dismiss
        data:
          notification_id: 'sensor_alert'

      # dismiss push notifications for all devices
      # - service: notify.html5_dismiss
      #   data:
      #     data:
      #       tag: 'sensor_alert'

      # turn automation back on
      - service: automation.turn_on
        entity_id: automation.system_close_sensor_unavailable_notifications

      # turn off alert automation
      - service: automation.turn_off
        entity_id: automation.system_sensor_unavailable_alert

      # wait for timeout or automation to be turned back on
      - wait_template: "{{ is_state('automation.system_sensor_unavailable_alert', 'on') }}"
        timeout: '04:00:00' # mute alert for 4 hours
        continue_on_timeout: true

      # turn alert automation back on
      - service: automation.turn_on
        entity_id: automation.system_sensor_unavailable_alert